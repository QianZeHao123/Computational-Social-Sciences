---
title: "Appendix for Computaional Social Science Summative"
author: "Z0195806"
date: "`r Sys.Date()`"
output: 
  pdf_document: 
    latex_engine: xelatex
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Appendix 1 Dataset Pre-processing

**Dataset World Values Survey Wave 7 (2017-2022)**

Link: <https://www.worldvaluessurvey.org/WVSDocumentationWV7.jsp>

**Dataset V-Dem (2022)**

Link: <https://www.v-dem.net/data/dataset-archive/>

It contains data files and original questionnaire.

I download the dataset from this link and put it in "./data" directory.

## 1.1 Read the data from the RData and RDS file

```{r}
current_directory = getwd()
# print(current_directory)
# actual path = current_directory
setwd(current_directory)
# load("./data/WVS_Cross-National_Wave_7_rData_v5_0.rdata")
# WVS.origin = `WVS_Cross-National_Wave_7_v5_0`
# v_dem_2022 = readRDS("./data/2022_CPD_V_Party_R_v2/V-Dem-CPD-Party-V2.rds")
```

## 1.2 Steps for Pre-processing

# Appendix 2 Read Democracy Dataset Directly

```{r}
dem_data = read.csv("./data/country_level_dem.csv")
```

```{r}
head(dem_data)
```

```{r}
# Using dim() to get both rows and columns
# Prints c(number_of_rows, number_of_columns)
print(dim(dem_data))
```

# Appendix 3 Basic EDA for dem_data

## 3.1 Summarize the Data

```{r}
print(summary(dem_data))
```

## 3.2 Check for Missing Values

```{r}
# Check if it exists missing value
any_missing_values = any(is.na(dem_data))
# Will print TRUE if there are any NAs, otherwise FALSE
print(any_missing_values)
```

## 3.3 Bar Plots for Political Satisfaction and Engagement

```{r message=FALSE, warning=FALSE}
# install.packages("ggplot2")
library(ggplot2)
ggplot(dem_data,
       aes(x = Country, y = Political.satisfaction,
           fill = Country
           )) +
  # Use identity to use the actual values from the data
  geom_bar(stat = "identity", color = "black") +
  labs(title = "Political Satisfaction by Country",
       x = "Country",
       y = "Political Satisfaction") +
  # Rotate x labels for better readability
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none")
```

```{r}
ggplot(dem_data,
       aes(x = Country,
           y = Perceived.quality.of.democracy,
           fill = Country
           )) +
  # Use identity to use the actual values from the data
  geom_bar(stat = "identity", color = "black") +
  labs(title = "Political Engagement by Country",
       x = "Country",
       y = "Political Engagement") +
  # Rotate x labels for better readability
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none")
```

## 3.4 Political Satisfaction and Engagement across Regime

```{r}
ggplot(dem_data, aes(x = Regime, y = Political.satisfaction)) +
  # geom_boxplot(fill = "tomato") +
  geom_boxplot(aes(color = Regime)) +
  labs(title = "Political Satisfaction Across Regimes",
       x = "Regime",
       y = "Political Satisfaction") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1))
```

```{r}
ggplot(dem_data, aes(x = Regime, y = Perceived.quality.of.democracy)) +
  geom_boxplot(aes(color = Regime)) +
  labs(title = "Political Engagement Across Regimes",
       x = "Regime",
       y = "Political Engagement") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1))
```

## 3.5 Relationship between Political Satisfaction and Social Media Use

```{r}
ggplot(dem_data, aes(x = Social.media.use, y = Political.satisfaction)) +
  # Color points by Regime to add another layer of information
  geom_point(aes(color = Country)) +
  labs(title = "Social Media Use vs. Political Satisfaction",
       x = "Social Media Use (%)",
       y = "Political Satisfaction") +
  theme(axis.text.x = element_text(angle = 0, hjust = 1),
        legend.position = "none")
```

## 3.6 Correlations between Variables

```{r message=FALSE, warning=FALSE}
# install.packages("dplyr")
library(dplyr)
library(stringr)
dem_data_cor = dem_data %>%
  mutate(Social.media.use = str_remove(Social.media.use, "%") %>% 
           as.numeric() %>% 
           `/`(100))
```

```{r message=FALSE, warning=FALSE}
# install.packages("GGally")
library("GGally")
ggpairs(dem_data_cor[, c("Affective.polarization",
                     "Issue.polarization",
                     "Social.media.use",
                     "Political.participation",
                     "Vote",
                     "Political.satisfaction",
                     "Perceived.quality.of.democracy")]) +
  theme_bw()
```

# Appendix 4 Processing with QCA

```{r}
# install QCA from CRAN
# install.packages("QCA")
```

## 4.1 Change the format of Social.media.use and Regime

```{r}
dem_data_new = dem_data %>%
  mutate(Social.media.use = str_remove(Social.media.use, "%") %>% 
           as.numeric() %>% 
           `/`(100),
         Regime = case_when(
           Regime == "Full" ~ 1,
           Regime == "Flawed" ~ 2,
           # Handles any unexpected categories
           TRUE ~ NA_real_
         ))
```

## 4.2 Histogram for Variables

```{r message=FALSE, warning=FALSE}
# ref: Computational Social Science Week 5: QCA Workshop
library(QCA)
```

```{r}
# Crisp set QCA
# Calibration discussion
# ------------------------------------------------------------
# Sorting and printing for each variable
# example for Printing and sorting for Affective Polarization
print("Affective Polarization")
sorted_AffectivePolarization <- sort(dem_data_new$Affective.polarization)
print(sorted_AffectivePolarization)

# Printing and sorting for Issue Polarization
print("Issue Polarization")
sorted_IssuePolarization <- sort(dem_data_new$Issue.polarization)
print(sorted_IssuePolarization)

# Printing and sorting for Social Media Use
print("Social Media Use")
sorted_SocialMediaUse <- sort(dem_data_new$Social.media.use)
print(sorted_SocialMediaUse)

remove(sorted_AffectivePolarization,
       sorted_IssuePolarization,
       sorted_SocialMediaUse)
```

```{r}
library(gridExtra)
# library(patchwork)
# Assuming dem_data_new is your dataset and variables are formatted as below
# Create and rename plot objects
Regime <-
  ggplot(dem_data_new, aes(x = Regime)) +
  geom_histogram(binwidth = 1,
                 fill = "pink",
                 color = "black") +
  ggtitle("Regime")
AffectivePolarization <-
  ggplot(dem_data_new, aes(x = Affective.polarization)) +
  geom_histogram(binwidth = 1,
                 fill = "blue",
                 color = "black") +
  ggtitle("Affective Polarization")

IssuePolarization <-
  ggplot(dem_data_new, aes(x = Issue.polarization)) +
  geom_histogram(binwidth = 1,
                 fill = "red",
                 color = "black") +
  ggtitle("Issue Polarization")

SocialMediaUse <- ggplot(dem_data_new, aes(x = Social.media.use)) +
  geom_histogram(binwidth = 1,
                 fill = "green",
                 color = "black") +
  ggtitle("Social Media Use")

PoliticalParticipation <-
  ggplot(dem_data_new, aes(x = Political.participation)) +
  geom_histogram(binwidth = 1,
                 fill = "orange",
                 color = "black") +
  ggtitle("Political Participation")

VoteHistogram <- ggplot(dem_data_new, aes(x = Vote)) +
  geom_histogram(binwidth = 1,
                 fill = "purple",
                 color = "black") +
  ggtitle("Vote")

PoliticalSatisfaction <-
  ggplot(dem_data_new, aes(x = Political.satisfaction)) +
  geom_histogram(binwidth = 1,
                 fill = "cyan",
                 color = "black") +
  ggtitle("Political Satisfaction")

QualityOfDemocracy <-
  ggplot(dem_data_new, aes(x = Perceived.quality.of.democracy)) +
  geom_histogram(binwidth = 1,
                 fill = "yellow",
                 color = "black") +
  ggtitle("Perceived Quality of Democracy")
# Arrange the plots
grid.arrange(
  Regime,
  AffectivePolarization,
  IssuePolarization,
  SocialMediaUse,
  PoliticalParticipation,
  VoteHistogram,
  PoliticalSatisfaction,
  QualityOfDemocracy,
  ncol = 2,
  nrow = 4
)
remove(
  AffectivePolarization,
  IssuePolarization,
  SocialMediaUse,
  PoliticalParticipation,
  VoteHistogram,
  PoliticalSatisfaction,
  QualityOfDemocracy,
  Regime
)
```

```{r}
# Set up the plot layout
# Adjust the numbers as needed to fit all your plots
par(mfrow = c(4, 2))
# Now call Xplot for each variable, they will be plotted in the layout
Xplot(
  dem_data_new$Regime,
  at = seq(from = 1, to = 2, by = 1),
)
Xplot(
  dem_data_new$Affective.polarization,
  at = seq(from = 0, to = 4, by = 1),
)
Xplot(
  dem_data_new$Issue.polarization,
  at = seq(from = 0, to = 4, by = 1),
)
Xplot(
  dem_data_new$Social.media.use,
  at = seq(from = 0.1, to = 0.7, by = 0.05),
)
Xplot(
  dem_data_new$Political.participation,
  at = seq(from = 0.4, to = 2.7, by = 0.05),
)
Xplot(dem_data_new$Vote,
      at = seq(from = 2.2, to = 3, by = 0.05),
)
Xplot(
  dem_data_new$Political.satisfaction,
  at = seq(from = 2.5, to = 7, by = 0.1),
)
Xplot(
  dem_data_new$Perceived.quality.of.democracy,
  at = seq(from = 3.5, to = 8, by = 0.1),
)
par(mfrow = c(1, 1))
```

## 4.3 Auto Calculating the thresholds for Crisp Set (Init)

```{r}
# Auto thresholds
# Finding threshold for Regime
Regime_Th <- findTh(
  dem_data_new$Regime,
  n = 1,
  hclustm = "complete",
  distm = "manhattan"
)
# Finding threshold for Affective Polarization
Affective_polarization_Th <- findTh(
  dem_data_new$Affective.polarization,
  n = 1,  # number of thresholds
  hclustm = "complete",  # hierarchical clustering method
  distm = "manhattan"  # distance measure
)

# Finding threshold for Issue Polarization
Issue_polarization_Th <- findTh(
  dem_data_new$Issue.polarization,
  n = 1,
  hclustm = "complete",
  distm = "manhattan"
)

# Finding threshold for Social Media Use
Social_media_use_Th <- findTh(
  dem_data_new$Social.media.use,
  n = 1,
  hclustm = "complete",
  distm = "manhattan"
)

# Finding threshold for Political Participation
Political_participation_Th <- findTh(
  dem_data_new$Political.participation,
  n = 1,
  hclustm = "complete",
  distm = "manhattan"
)

# Finding threshold for Vote
Vote_Th <- findTh(
  dem_data_new$Vote,
  n = 1,
  hclustm = "complete",
  distm = "manhattan"
)

# Finding threshold for Political Satisfaction
Political_satisfaction_Th <- findTh(
  dem_data_new$Political.satisfaction,
  n = 1,
  hclustm = "complete",
  distm = "manhattan"
)

# Finding threshold for Perceived Quality of Democracy
Perceived_quality_of_democracy_Th <- findTh(
  dem_data_new$Perceived.quality.of.democracy,
  n = 1,
  hclustm = "complete",
  distm = "manhattan"
)
```

```{r}
# organize thresholds
thresholds <- data.frame(
  Variable = c(
    "Regime",
    "Affective Polarization",
    "Issue Polarization",
    "Social Media Use",
    "Political Participation",
    "Vote",
    "Political Satisfaction",
    "Perceived Quality of Democracy"
  ),
  Threshold = c(
    Regime_Th,
    Affective_polarization_Th,
    Issue_polarization_Th,
    Social_media_use_Th,
    Political_participation_Th,
    Vote_Th,
    Political_satisfaction_Th,
    Perceived_quality_of_democracy_Th
  )
)
print(thresholds)
remove(thresholds)
```

## 4.4 Calibrate the Data with thresholds

```{r}
# Regime
dem_data_new$Regime_cs = calibrate(
  dem_data_new$Regime,
  type = "crisp",
  thresholds = Regime_Th
)
# Affective polarization
dem_data_new$Affective_polarization_cs = calibrate(
  dem_data_new$Affective.polarization,
  type = "crisp",
  # thresholds = Affective_polarization_Th # 1.5
  thresholds = 2
)
# Issue Polarization
dem_data_new$Issue_polarization_cs = calibrate(
  dem_data_new$Issue.polarization,
  type = "crisp",
  # thresholds = Issue_polarization_Th # 1.5
  thresholds = 2
)
# Social Media Use
dem_data_new$Social_media_use_cs = calibrate(
  dem_data_new$Social.media.use,
  type = "crisp",
  # thresholds = Social_media_use_Th # 0.345
  thresholds = 0.4
)
# Political Participation
dem_data_new$Political_participation_cs = calibrate(
  dem_data_new$Political.participation,
  type = "crisp",
  thresholds = Political_participation_Th
)
# Vote
dem_data_new$Vote_cs = calibrate(
  dem_data_new$Vote,
  type = "crisp",
  # thresholds = Vote_Th # 2.685
  thresholds = 2.4
)

# Political Satisfaction
dem_data_new$Political_satisfaction_cs = calibrate(
  dem_data_new$Political.satisfaction,
  type = "crisp",
  # thresholds = Political_satisfaction_Th # 4.285
  thresholds = 6.5
)
# Perceived Quality of Democracy
dem_data_new$Perceived_quality_of_democracy_cs = calibrate(
  dem_data_new$Perceived.quality.of.democracy,
  type = "crisp",
  # thresholds = Perceived_quality_of_democracy_Th # 4.45
  thresholds = 7
)
```

```{r}
remove(
  Affective_polarization_Th,
  Issue_polarization_Th,
  Social_media_use_Th,
  Political_participation_Th,
  Vote_Th,
  Political_satisfaction_Th,
  Perceived_quality_of_democracy_Th,
  Regime_Th
)
```

## 4.5 Construct Truth Tables

```{r}
DemCrisp <- dem_data_new[, c(
  "Regime_cs",
  "Affective_polarization_cs",
  "Issue_polarization_cs",
  "Social_media_use_cs",
  "Political_participation_cs",
  "Vote_cs",
  "Political_satisfaction_cs",
  "Perceived_quality_of_democracy_cs"
)]
DemCrisp.sim = DemCrisp
# Assigning new simpler names
names(DemCrisp.sim) <- c(
  "Regime",
  "AffectPol",
  "IssuePol",
  "SocialMedia",
  "PolPart",
  "Vote",
  "PolSat",
  "QualDem"
)
```

```{r message=FALSE, warning=FALSE}
conditionCounts <- as.data.frame(DemCrisp.sim) %>%
  mutate(conditions = paste0(Regime,
                             AffectPol,
                             IssuePol,
                             SocialMedia,
                             PolPart,
                             Vote,
                             QualDem
                             )) %>%
  group_by(conditions, PolSat) %>%
  summarise(cases = n())
print(conditionCounts)
```

## 4.6 Extracting causal recipes

```{r}
TTDem = truthTable(
  DemCrisp.sim,
  outcome = "PolSat",
  complete = TRUE,
  show.cases = TRUE
)
```

## 4.7 Minimize Truth Tables

```{r}
complexDemCrisp = minimize(TTDem, details = TRUE)
complexDemCrisp
```

```{r}
complexDemCrisp$PIchart
```

```{r}
# Parsimonious ComplexDemCrisp
ParComplexDemCrisp <- minimize(TTDem, include = "?", details = TRUE)
ParComplexDemCrisp
```

```{r}
ParComplexDemCrisp$PIchart
```

# Appendix 5 Comparison

```{r}
dem_data_reg = dem_data_cor
dem_data_reg$Country = as.factor(dem_data_reg$Country)
dem_data_reg$Regime = as.factor(dem_data_reg$Regime)
```

```{r message=FALSE, warning=FALSE}
# install.packages("lme4")
# install.packages("lmerTest")
library(lme4)
library(lmerTest)
model = lmer(
  Political.satisfaction ~
    Regime +
    Affective.polarization +
    Issue.polarization +
    Social.media.use +
    Political.participation +
    Vote +
    Perceived.quality.of.democracy +
    (1 | Regime),
  data = dem_data_new
)
```

```{r}
summary(model)
```
